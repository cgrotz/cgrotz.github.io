<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.1a54add997246827ae7a.css" id="gatsby-global-css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.32.4"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=f29c3c1906871bf95ca26997b59ae6e0" type="image/png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=f29c3c1906871bf95ca26997b59ae6e0"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=f29c3c1906871bf95ca26997b59ae6e0"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=f29c3c1906871bf95ca26997b59ae6e0"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=f29c3c1906871bf95ca26997b59ae6e0"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=f29c3c1906871bf95ca26997b59ae6e0"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=f29c3c1906871bf95ca26997b59ae6e0"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=f29c3c1906871bf95ca26997b59ae6e0"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=f29c3c1906871bf95ca26997b59ae6e0"/><title data-react-helmet="true">Processing the Firmware Installation | Christoph&#x27;s Blog about Digital Stuff</title><meta data-react-helmet="true" name="description" content="In this part we process the firmware installation from Bosch IoT Rollouts"/><meta data-react-helmet="true" property="og:title" content="Processing the Firmware Installation"/><meta data-react-helmet="true" property="og:description" content="In this part we process the firmware installation from Bosch IoT Rollouts"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="christoph_grotz"/><meta data-react-helmet="true" name="twitter:title" content="Processing the Firmware Installation"/><meta data-react-helmet="true" name="twitter:description" content="In this part we process the firmware installation from Bosch IoT Rollouts"/><link as="script" rel="preload" href="/webpack-runtime-7d781e5aaef61d71635e.js"/><link as="script" rel="preload" href="/framework-de237a875aa45b276a9d.js"/><link as="script" rel="preload" href="/styles-55e82d6ff5158c00b714.js"/><link as="script" rel="preload" href="/app-7ef41b0313eddfac591a.js"/><link as="script" rel="preload" href="/commons-307180b35163f2ba04f5.js"/><link as="script" rel="preload" href="/cd7d5f864fc9e15ed8adef086269b0aeff617554-a00ededa45cacb6035e8.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-1cd52b0ae192e19e50d5.js"/><link as="fetch" rel="preload" href="/page-data/2020-09-01-esp32_ci_cd_part6/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1246554614.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2841359383.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;color:inherit" href="/">Christoph&#x27;s Blog about Digital Stuff</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">Processing the Firmware Installation</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">September 01, 2020</p></header><section><p>This is the sixth part of a multi-part blog post. You might want to start from the beginning with the <a href="/2020-08-23-esp32_ci_cd_part1">first post</a>.</p>
<p>In the <a href="/2020-08-31-esp32_ci_cd_part5">previous part</a> I showed you how to establish connection with the Bosch IoT Suite. In this part I will be showing you the necessary steps to receive firmware update commands from the IoT Suite and flash the firmware onto the device. Let’s start by adding a few headers that we are going to need for this project.</p>
<div class="gatsby-highlight" data-language="cpp"><pre class="language-cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Update.h></span>       <span class="token comment">// The OTA client of the ESP32</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;HTTPClient.h></span>   <span class="token comment">// The HTTP Client for downloading the firmware</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Stream.h></span>       <span class="token comment">// We need this for streaming the file to the flash</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;StreamString.h></span></span></code></pre></div>
<p>When a distribution set is assigned to a target in IoT Rollouts, IoT Manager will translate this into an install command on the device shadow in case that the device shadow has a <a href="https://vorto.eclipse.org/#/details/org.eclipse.hawkbit.swupdatable:SoftwareUpdatable:2.0.0">SoftwareUpdatable</a> function block. (Version 1 of the Vorto Functionblock will only be supported during the public Beta of the Device Management Package) So step 1 is registering the SoftwareUpdateable function block. Let’s extend the connect function to update the device shadow.</p>
<div class="gatsby-highlight" data-language="cpp"><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>

  <span class="token comment">// Update device shadow with SoftwareUpdateable function block</span>
  <span class="token keyword">char</span> payload<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">sprintf</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token string">"{\r\n\t\"topic\": \"%s/%s/things/twin/commands/modify\",\r\n\t\"path\": \"/features/softwareupdatable\",\r\n\t\"value\": {\r\n\t \t\"definition\": [\r\n\t \t\t\"org.eclipse.hawkbit.swupdatable:SoftwareUpdatable:1.0.0\"\r\n\t \t],\r\n \t \t\"properties\": {\r\n \t\t \t\"status\": {\r\n \t\t\t \t\"agentName\" : \"m5stack\",\r\n \t\t\t \t\"agentVersion\" : \"1.0.0\",\r\n \t\t\t \t\"type\" : \"application\"\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}"</span><span class="token punctuation">,</span> hubNamespace<span class="token punctuation">,</span> deviceId <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    M5<span class="token punctuation">.</span>Lcd<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Failed publishing "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    M5<span class="token punctuation">.</span>Lcd<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">lastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Something to point out is the type property that identifie what type of software module the device shadow accepts. In this case type has the value <em>application</em>, this needs to correlate with the type on the SoftwareModule we are creating in IoT Rollouts.</p>
<p>The message send from the Suite to the device will then look similar to this:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"topic"</span><span class="token operator">:</span> <span class="token string">"namespace/thing_id/things/live/messages/install"</span><span class="token punctuation">,</span>
	<span class="token property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"content-type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span>
		<span class="token property">"version"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
		<span class="token property">"correlation-id"</span><span class="token operator">:</span> <span class="token string">"p-pdid85-1fzfisu1ae6v5f-3vj06"</span><span class="token punctuation">,</span>
		<span class="token property">"x-things-parameter-order"</span><span class="token operator">:</span> <span class="token string">"[\"arg_0\"]"</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/features/softwareupdatable/inbox/messages/install"</span><span class="token punctuation">,</span>
	<span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"arg_0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"softwareModules"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
				<span class="token property">"metaData"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"test"</span><span class="token punctuation">,</span>
				<span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
				<span class="token property">"artifacts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
					<span class="token property">"filename"</span><span class="token operator">:</span> <span class="token string">"generated_eclipseditto_1.0.0-SNAPSHOT_SoftwareUpdatable_thingJson.json"</span><span class="token punctuation">,</span>
					<span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">764</span><span class="token punctuation">,</span>
					<span class="token property">"hashes"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
						<span class="token property">"sha1"</span><span class="token operator">:</span> <span class="token string">"d12f37d9774e1cf2f9bfcc21a2f1091617775a58"</span><span class="token punctuation">,</span>
						<span class="token property">"sha256"</span><span class="token operator">:</span> <span class="token string">"e3399ace3f2cc70f337f3be894852d307e5a10abec163ac7dc53148984b70537"</span><span class="token punctuation">,</span>
						<span class="token property">"md5"</span><span class="token operator">:</span> <span class="token string">"d173d3d61191d5d8f4b630889905b054"</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token property">"links"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
						<span class="token property">"download"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
							<span class="token property">"http"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
							<span class="token property">"https"</span><span class="token operator">:</span> <span class="token string">"https://link to artifact"</span>
						<span class="token punctuation">}</span><span class="token punctuation">,</span>
						<span class="token property">"md5sum"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token property">"dsMetaData"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token property">"weight"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
			<span class="token property">"correlationId"</span><span class="token operator">:</span> <span class="token string">"32845"</span><span class="token punctuation">,</span>
			<span class="token property">"actionProperties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
				<span class="token property">"actionType"</span><span class="token operator">:</span> <span class="token string">"FORCED"</span><span class="token punctuation">,</span>
				<span class="token property">"forceTime"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The key elements that we will need to process are the path property, the correlationId of the software installation request <em>value.arg_0.correlationId</em> and the url to the artifact <em>value.arg_0.softwareModules.[].artifacts.[].links.download.https</em>. Let’s add the handling code with some global variables for processing the message. (The arg_0 will be replaced after the public beta with the correct property name).</p>
<div class="gatsby-highlight" data-language="cpp"><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// New global variables</span>
String INSTALLATION_PATH <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"/features/softwareupdatable/inbox/messages/install"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> installationState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
StaticJsonDocument<span class="token operator">&lt;</span><span class="token number">2000</span><span class="token operator">></span> installationCommand<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">messageReceived</span><span class="token punctuation">(</span>String <span class="token operator">&amp;</span>mqttTopic<span class="token punctuation">,</span> String <span class="token operator">&amp;</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// ...</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>INSTALLATION_PATH<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    installationState <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    installationCommand <span class="token operator">=</span> doc<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>In case that we receive a installation command, we store the whole message and set the state to 1, to indicate that in the next run of the loop function we want to process the firmware update. We do this since we will need to communicate with the IoT Suite and we shouldn’t do this from the messageReceived callback.</p>
<p>Next I am going to extend the loop function for processing the software update state. It will extract the remaining information from the cached message, and trigger a download and installation function.</p>
<div class="gatsby-highlight" data-language="cpp"><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>installationState <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> correlationId <span class="token operator">=</span> installationCommand<span class="token punctuation">[</span><span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"arg_0"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"correlationId"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    JsonArray softwareModules <span class="token operator">=</span> installationCommand<span class="token punctuation">[</span><span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"arg_0"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"softwareModules"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>JsonArray<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>JsonVariant v <span class="token operator">:</span> softwareModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      JsonObject moduleDoc <span class="token operator">=</span> v<span class="token punctuation">.</span>as<span class="token operator">&lt;</span>JsonObject<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      String module <span class="token operator">=</span> moduleDoc<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      String version <span class="token operator">=</span> moduleDoc<span class="token punctuation">[</span><span class="token string">"version"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      
      client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token function">buildInstallationState</span><span class="token punctuation">(</span>correlationId<span class="token punctuation">,</span> module<span class="token punctuation">,</span> version<span class="token punctuation">,</span> <span class="token string">"STARTED"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      JsonArray artifacts <span class="token operator">=</span> moduleDoc<span class="token punctuation">[</span><span class="token string">"artifacts"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>as<span class="token operator">&lt;</span>JsonArray<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span><span class="token punctuation">(</span>JsonVariant artifactVariant <span class="token operator">:</span> artifacts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        JsonObject artifact <span class="token operator">=</span> artifactVariant<span class="token punctuation">.</span>as<span class="token operator">&lt;</span>JsonObject<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String filename <span class="token operator">=</span> artifact<span class="token punctuation">[</span><span class="token string">"filename"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        String md5 <span class="token operator">=</span> artifact<span class="token punctuation">[</span><span class="token string">"hashes"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"md5"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        String url <span class="token operator">=</span> artifact<span class="token punctuation">[</span><span class="token string">"links"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"download"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"https"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">downloadAndInstallFirmware</span><span class="token punctuation">(</span>correlationId<span class="token punctuation">,</span> module<span class="token punctuation">,</span> version<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    installationState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The <em>downloadAndInstallFirmware</em> function will open a HTTPS connection to start downloading the artifact as a stream and pass it to the update handler of the ESP32. It will also create MQTT messages in order to update the device shadow. The IoT Suite transforms this shadow updates into state tranistions on the Distribution Set assignment in IoT Rollouts. You can find the code for the <em>buildInstallationState</em> helper functions down below.</p>
<p>The update itself is handled by four functions, that are part of the ESP32’s Update functionality. <em>Update.begin(int update_size)</em> needs to be called when you want to start an update, it responds true if the device is ready to be updated and the update size doesn’t exceed the parition size. <em>Update.writeStream(stream)</em> takes a binary stream that should be written to the flash storage. With <em>Update.end()</em> you can inform the ESP32 that the whole stream was transfered, with <em>Update.isFinished()</em> you can check if the ESP32 succesfully checked and accepted the update.</p>
<div class="gatsby-highlight" data-language="cpp"><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">downloadAndInstallFirmware</span><span class="token punctuation">(</span>String correlationId<span class="token punctuation">,</span> String module<span class="token punctuation">,</span> 
    String version<span class="token punctuation">,</span> String url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WiFiClientSecure net2<span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[HTTPS] Downloading Firmware %s\n"</span><span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  HTTPClient https<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>https<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>net2<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> httpCode <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// httpCode will be negative on error</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>httpCode <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// HTTP header has been send and Server response header has been handled</span>
      Serial<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[HTTPS] GET... code: %d\n"</span><span class="token punctuation">,</span> httpCode<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// file found at server</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>httpCode <span class="token operator">==</span> HTTP_CODE_OK <span class="token operator">||</span> httpCode <span class="token operator">==</span> HTTP_CODE_MOVED_PERMANENTLY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token function">buildInstallationState</span><span class="token punctuation">(</span>correlationId<span class="token punctuation">,</span> module<span class="token punctuation">,</span> version<span class="token punctuation">,</span> <span class="token string">"INSTALLING"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> canBegin <span class="token operator">=</span> Update<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span>https<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>canBegin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Update<span class="token punctuation">.</span><span class="token function">writeStream</span><span class="token punctuation">(</span>https<span class="token punctuation">.</span><span class="token function">getStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span><span class="token function">connected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Update<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"OTA done!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token function">buildInstallationState</span><span class="token punctuation">(</span>correlationId<span class="token punctuation">,</span> module<span class="token punctuation">,</span> version<span class="token punctuation">,</span> <span class="token string">"INSTALLED"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Update<span class="token punctuation">.</span><span class="token function">isFinished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token function">buildInstallationState</span><span class="token punctuation">(</span>correlationId<span class="token punctuation">,</span> module<span class="token punctuation">,</span> version<span class="token punctuation">,</span> <span class="token string">"FINISHED_SUCCESS"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              restart <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token function">buildInstallationState</span><span class="token punctuation">(</span>correlationId<span class="token punctuation">,</span> module<span class="token punctuation">,</span> version<span class="token punctuation">,</span> <span class="token string">"FINISHED_ERROR"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Update not finished? Something went wrong!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"event"</span><span class="token punctuation">,</span> <span class="token function">buildInstallationState</span><span class="token punctuation">(</span>correlationId<span class="token punctuation">,</span> module<span class="token punctuation">,</span> version<span class="token punctuation">,</span> <span class="token string">"FINISHED_ERROR"</span><span class="token punctuation">,</span> <span class="token string">"Error Occurred. Error #: "</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>Update<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error Occurred. Error #: "</span> <span class="token operator">+</span> <span class="token function">String</span><span class="token punctuation">(</span>Update<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      Serial<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[HTTPS] GET... failed, error: %s\n"</span><span class="token punctuation">,</span> https<span class="token punctuation">.</span><span class="token function">errorToString</span><span class="token punctuation">(</span>httpCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    https<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Failed downloading"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>In the following snippet you will find the <em>buildInstallationState</em> helper functions.</p>
<div class="gatsby-highlight" data-language="cpp"><pre class="language-cpp"><code class="language-cpp">String <span class="token function">buildInstallationState</span><span class="token punctuation">(</span>String correlationId<span class="token punctuation">,</span> String moduleName<span class="token punctuation">,</span> 
    String version<span class="token punctuation">,</span> String state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">char</span> payload<span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"{\r\n\t\"topic\": \""</span><span class="token operator">+</span>hubNamespace<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>deviceId<span class="token operator">+</span><span class="token string">"/things/twin/commands/modify\",\r\n\t\"path\": \"/features/"</span><span class="token operator">+</span>moduleName<span class="token operator">+</span><span class="token string">"\",\r\n\t\"value\": {\r\n\t \t\"definition\": [\r\n\t \t\t\"org.eclipse.hawkbit.swmodule:SoftwareModule:1.0.0\"\r\n\t \t],\r\n \t \t\"properties\": {\r\n \t\t \t\"status\": {\r\n \t\t\t \t\"moduleName\" : \""</span><span class="token operator">+</span>moduleName<span class="token operator">+</span><span class="token string">"\",\r\n \t\t\t \t\"moduleVersion\" : \""</span><span class="token operator">+</span>version<span class="token operator">+</span><span class="token string">"\",\r\n \t\t\t \t\"status\" : {\r\n\t\t\t\t\t\"correlationId\": \""</span><span class="token operator">+</span>correlationId<span class="token operator">+</span><span class="token string">"\",\r\n\t\t\t\t\t\"operation\": \"install\",\r\n\t\t\t\t\t\"status\": \""</span><span class="token operator">+</span>state<span class="token operator">+</span><span class="token string">"\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

String <span class="token function">buildInstallationState</span><span class="token punctuation">(</span>String correlationId<span class="token punctuation">,</span> String moduleName<span class="token punctuation">,</span> 
    String version<span class="token punctuation">,</span> String state<span class="token punctuation">,</span> String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"{\r\n\t\"topic\": \""</span><span class="token operator">+</span>hubNamespace<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>deviceId<span class="token operator">+</span><span class="token string">"/things/twin/commands/modify\",\r\n\t\"path\": \"/features/"</span><span class="token operator">+</span>moduleName<span class="token operator">+</span><span class="token string">"\",\r\n\t\"value\": {\r\n\t \t\"definition\": [\r\n\t \t\t\"org.eclipse.hawkbit.swmodule:SoftwareModule:1.0.0\"\r\n\t \t],\r\n \t \t\"properties\": {\r\n \t\t \t\"status\": {\r\n \t\t\t \t\"moduleName\" : \""</span><span class="token operator">+</span>moduleName<span class="token operator">+</span><span class="token string">"\",\r\n \t\t\t \t\"moduleVersion\" : \""</span><span class="token operator">+</span>version<span class="token operator">+</span><span class="token string">"\",\r\n \t\t\t \t\"status\" : {\r\n\t\t\t\t\t\"correlationId\": \""</span><span class="token operator">+</span>correlationId<span class="token operator">+</span><span class="token string">"\",\r\n\t\t\t\t\t\"operation\": \"install\",\r\n\t\t\t\t\t\"status\": \""</span><span class="token operator">+</span>state<span class="token operator">+</span><span class="token string">"\",\r\n\t\t\t\t\t\"message\": \""</span><span class="token operator">+</span>message<span class="token operator">+</span><span class="token string">"\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>As always, you can find the complete <a href="https://github.com/cgrotz/esp32-cd-firmware-example">sources</a> on GitHub.</p>
<h2>Conclusion</h2>
<p>Voilà, we are at the end. Pushed to the master branch in Github will now create a new firmware image, that is automatically pushed to the Bosch IoT Suite, which in turn automatically assigns it to the device, the device will then self update.</p>
<p>There is a lot of room for improvement for this simple example. Let’s make a short list of a few points I would consider. I bet there are many more that you might come up with.</p>
<h3>device Configuration not externalized</h3>
<p>In the above code, the Wifi configuration as well as the device credentials are hard coded into the code. This should be externalized to the flash or a SD storage. This way the firmware image is not device specific anymore.</p>
<h3>Resilience for firmware flashing</h3>
<p>At the moment the firmware image is downloaded and directly streamed to the ESP32’s unused firmware partition. Since the ESP32 uses a two partition concept for firmware update and checks the partition, we already have some resilience (<a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-reference/system/ota.html">OTA Process Documentation</a>. It would still be good to download the file and verify the downloaded image against the checksum.</p>
<p>Also having a potential rollback after updating in case that the device is not able to for example connect would be nice. But this obviously also necessitates to externalize the update state to the flash or SD storage.</p>
<h3>Code Cleanup</h3>
<p>I tried to keep the whole code in a single file, to make it easier to understand for a person reading the blog. In a real production setting it would of course be better to separate the different concers into separate components.</p>
<p>Of course other things like the BAUD Rate would be more suitable in a #define statement.</p>
<h3>State Handling</h3>
<p>The way that the install state is handled is definitely not a good way to do it in production. There are multiple states that aren’t handled properly. In a real production scenario you should use a proper state machine to hande this, or maybe use RTOS task scheduling to handle the state transitions.</p>
<p>Thanks for reading this long blog post. I hope you were able to take away some information or ideas.</p></section><hr style="margin-bottom:1.75rem"/><div class="postmetadata">Posted on <span class="updated">September 01, 2020</span></div><footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAUDBAL/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHT3wbFJzCFbCaD/8QAHhAAAgEDBQAAAAAAAAAAAAAAAQIEAAMREhMiMkH/2gAIAQEAAQUCuFlQng2MvIoFyiPrHsDpKG3f/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAHBABAAMAAwEBAAAAAAAAAAAAAQACERASQTFh/9oACAEBAAY/AlzYL5jwhUjfp2o+bNcOLH7Er8n/xAAaEAEAAwEBAQAAAAAAAAAAAAABABEhMWFx/9oACAEBAAE/IfigKlPYXCooBpvVlIAutEu0YaoYzdc4YIWG6qf/2gAMAwEAAgADAAAAEDDIAP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EABwQAQEBAQADAQEAAAAAAAAAAAERACExQWGBsf/aAAgBAQABPxAmhkAXVZkcX1UlKT91EnjJQkYKbPYGv8AhhfhZidYtHJ/dJIc7kgEyngp3dSYPku//2Q==" alt="Christoph Grotz" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/ad9e1b3f94285ae133ff9f657c5b04aa/99438/profile-pic.jpg 1x,
/static/ad9e1b3f94285ae133ff9f657c5b04aa/aba1d/profile-pic.jpg 1.5x,
/static/ad9e1b3f94285ae133ff9f657c5b04aa/b315d/profile-pic.jpg 2x" /><img loading="lazy" width="50" height="50" srcset="/static/ad9e1b3f94285ae133ff9f657c5b04aa/99438/profile-pic.jpg 1x,
/static/ad9e1b3f94285ae133ff9f657c5b04aa/aba1d/profile-pic.jpg 1.5x,
/static/ad9e1b3f94285ae133ff9f657c5b04aa/b315d/profile-pic.jpg 2x" src="/static/ad9e1b3f94285ae133ff9f657c5b04aa/99438/profile-pic.jpg" alt="Christoph Grotz" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p>Written by <strong>Christoph Grotz</strong> <!-- -->who uses this blog to document his learnings regarding new tech trends.<!-- --> <a href="https://twitter.com/christoph_grotz">You should follow him on Twitter.</a><br/>He is also sharing his current view on the tech landscape<!-- --> <a href="/radar">as a tech radar.</a></p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/2020-08-31-esp32_ci_cd_part5/">← <!-- -->Connecting the ESP32 to the Bosch IoT Suite</a></li><li><a rel="next" href="/2021-03-14-covid-data-with-dataflow-and-bigquery/">Analyzing Covid Data with Dataflow and BigQuery<!-- --> →</a></li></ul></nav></main><footer>© <!-- -->2021<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2020-09-01-esp32_ci_cd_part6/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-2966d4d8fea208fd6f8f.js"],"app":["/app-7ef41b0313eddfac591a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-2b2a6265e334b751dbf1.js"],"component---src-pages-index-js":["/component---src-pages-index-js-ae892dba55b2bc3ecb55.js"],"component---src-pages-radar-js":["/component---src-pages-radar-js-19a75e5169f13cb7a72e.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-65388f52eac3bde20983.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-1cd52b0ae192e19e50d5.js"]};/*]]>*/</script><script src="/polyfill-2966d4d8fea208fd6f8f.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-1cd52b0ae192e19e50d5.js" async=""></script><script src="/cd7d5f864fc9e15ed8adef086269b0aeff617554-a00ededa45cacb6035e8.js" async=""></script><script src="/commons-307180b35163f2ba04f5.js" async=""></script><script src="/app-7ef41b0313eddfac591a.js" async=""></script><script src="/styles-55e82d6ff5158c00b714.js" async=""></script><script src="/framework-de237a875aa45b276a9d.js" async=""></script><script src="/webpack-runtime-7d781e5aaef61d71635e.js" async=""></script></body></html>