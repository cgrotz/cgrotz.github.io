{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-08-31-esp32_ci_cd_part5/","result":{"data":{"site":{"siteMetadata":{"title":"Christoph's Blog about Digital Stuff"}},"markdownRemark":{"id":"3b8e0a14-33d6-5dc9-9d5b-d3ece8c422d9","excerpt":"This is the fifth part of a multi-part blog post. You might want to start from the beginning with the first post. In this part we beginn with connecting our…","html":"<p>This is the fifth part of a multi-part blog post. You might want to start from the beginning with the <a href=\"/2020-08-23-esp32_ci_cd_part1\">first post</a>.</p>\n<p>In this part we beginn with connecting our device with the Bosch IoT Suite. In order to do this, we need to establish a MQTT connection to the IoT Hub. We will also update the devices digital twin in IoT Things to verify the connection.</p>\n<p>In the <a href=\"/2020-08-23-esp32_ci_cd_part4\">last part</a>, we made the necessary configuration in the IoT Suite and provisioned our device, we will need the credentials in this part. You can find the full code example at the bottom of the page.</p>\n<p>Let’s start with a basic project setup, in the following platformio.ini you can see the libraries necessary for our approach</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token selector\">[env:m5stack-core-esp32]</span>\n<span class=\"token constant\">platform</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> espressif32</span>\n<span class=\"token constant\">framework</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> arduino</span>\n<span class=\"token constant\">board</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> m5stack-core-esp32</span>\n<span class=\"token constant\">lib_deps</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> </span>\n\tMQTT@^2.4.7         ; The MQTT Client\n\tArduinoJson@^6.16.1 ; A library for decoding the JSON messages from Bosch IoT Things</code></pre></div>\n<p><em>platformio.ini for our project</em></p>\n<p>At the moment our main.cpp is probably rather empty and should look like the following example.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Arduino.h></span></span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// put your setup code here, to run once:</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// put your main code here, to run repeatedly:</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>The starting point main.cpp</em></p>\n<p>So let’s start with adding some headers for the libraries that we need.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Arduino.h></span> </span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ArduinoJson.h></span> <span class=\"token comment\">// JSON Serialization and Deserialization</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;MQTT.h></span> <span class=\"token comment\">// MQTT communication</span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;WiFiClientSecure.h></span> <span class=\"token comment\">// Wifi Client with TLS support </span></span></code></pre></div>\n<p>What sticks out is, the <em>WiFiClientSecure.h</em> since the Bosch IoT Hub uses TLS encrypted communication we cannot just use the default WifiClient for establishing the TCP connections for accessing the MQTT connector of the IoT Hub.</p>\n<p>Next we need to make the Wifi connection. You will need to replace the place holders with your actual wifi configuration</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">void</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nchecking wifi...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>WiFi<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> WL_CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" connected to wifi!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token number\">115200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  WiFi<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"your wifi SSID\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"your wifi password\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>No that we have our Wifi connection we need to establish the MQTT connection. Let’s add a <em>WifiClientSecure</em> and a <em>MQTTClient</em> to our global variables.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">WiFiClientSecure net<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// We need to increase message size since the IoT Suite messages can be rather big</span>\nMQTTClient <span class=\"token function\">client</span><span class=\"token punctuation\">(</span><span class=\"token number\">2048</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Next steps is initalize the clients. We do this in the <em>connect</em> function we previously created.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">void</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nconnecting to mqtt...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mqtt.bosch-iot-hub.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8883</span><span class=\"token punctuation\">,</span> net<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"namespace:deviceId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"namespace_deviceId@tenantId\"</span><span class=\"token punctuation\">,</span> mqttPassword<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// we need to call client loop in order for the mqtt client to process messages</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// we add a few millisecond delay for wifi stability</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">connected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// in case that the mqtt client is not connected anymore, we want to trigger a reconnect</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This should successfully connect the MQTT client, but how do can you tell? In the Bosch IoT Things dashboard your device should look very empty at the moment. (If you already connected it, you might see a connection status feature).</p>\n<p>Let’s send a periodic message to IoT Things from the loop method, that updates the digital twin of the device. You will need to replace <em><namespace></em> and <em><deviceId></em> with the values from your device registration.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> lastMillis <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token comment\">// publish a message roughly every second.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastMillis <span class=\"token operator\">></span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    lastMillis <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"event\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"{\\r\\n\\t\\\"topic\\\": \\\"&lt;namespace>/&lt;deviceId>/things/twin/commands/modify\\\",\\r\\n\\t\\\"path\\\": \\\"/features/version\\\",\\r\\n\\t\\\"value\\\": {\\r\\n\\t \\t\\\"properties\\\": {\\r\\n \\t\\t \\t\\\"version\\\": \\\"1.0.8\\\"\\r\\n\\t\\t}\\r\\n\\t}\\r\\n}\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed publishing \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">lastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The digital twin in the Things dashboard should now be updated, and should contain a new feature called version that has a property version with the value 1.0.0.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/60843df04ec0fe77fe12ab32c1deaa19/80521/device_with_version.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.7027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAApElEQVQY04WQjQ6DMAiEff9HrbOx6U9SBG7SqtPMOZILDaHfAYNzDrVWWKjql2A6xV2Pbj3EgmEcR3jvkXPZfuDInadgZsQYQUSPUDagNc7BIySPRSoql9WptLeqNKiIIKWEEAIW7vWr+8dkKKUg5QhWapBdLHSssmebVIQv9fPKDWju02ta3WckmpDJsocobzNcPz1FA7Zjrrep1Kfa9etO//QGREfZycGUCicAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"device with version\"\n        title=\"device with version\"\n        src=\"/static/60843df04ec0fe77fe12ab32c1deaa19/fcda8/device_with_version.png\"\n        srcset=\"/static/60843df04ec0fe77fe12ab32c1deaa19/12f09/device_with_version.png 148w,\n/static/60843df04ec0fe77fe12ab32c1deaa19/e4a3f/device_with_version.png 295w,\n/static/60843df04ec0fe77fe12ab32c1deaa19/fcda8/device_with_version.png 590w,\n/static/60843df04ec0fe77fe12ab32c1deaa19/efc66/device_with_version.png 885w,\n/static/60843df04ec0fe77fe12ab32c1deaa19/c83ae/device_with_version.png 1180w,\n/static/60843df04ec0fe77fe12ab32c1deaa19/80521/device_with_version.png 2416w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n<em>Digital Twin with version feature</em></p>\n<p>Last but not least, we would also like to be able to receive messages from the IoT Suite. We will not use this in this post directly, but I think this post wouldn’t be complete without this step.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// add this method as a callback, for receiving new messages</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">messageReceived</span><span class=\"token punctuation\">(</span>String <span class=\"token operator\">&amp;</span>mqttTopic<span class=\"token punctuation\">,</span> String <span class=\"token operator\">&amp;</span>payload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  StaticJsonDocument<span class=\"token operator\">&lt;</span><span class=\"token number\">2000</span><span class=\"token operator\">></span> doc<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">deserializeJson</span><span class=\"token punctuation\">(</span>doc<span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  String topic <span class=\"token operator\">=</span> doc<span class=\"token punctuation\">[</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  String path <span class=\"token operator\">=</span> doc<span class=\"token punctuation\">[</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"incoming topic: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" path: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"incoming: \"</span> <span class=\"token operator\">+</span> mqttTopic <span class=\"token operator\">+</span> <span class=\"token string\">\" - \"</span> <span class=\"token operator\">+</span> payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// Note: Do not use the client in the callback to publish, subscribe or</span>\n  <span class=\"token comment\">// unsubscribe as it may cause deadlocks when other things arrive while</span>\n  <span class=\"token comment\">// sending and receiving acknowledgments. Instead, change a global variable,</span>\n  <span class=\"token comment\">// or push to a queue and handle it in the loop after calling `client.loop()`.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ... add the following line below client.begin(\"mqtt.bosch-iot-hub.com\", 8883, net);</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span>messageReceived<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ... add the following line below the client connect loop</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"command///req/#\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In the <em>messageReceived</em> function, I am using ArduinoJson to extract the JSON payload. Let’s have a quick look at the typical message structure Eclipse Ditto is using (on which Bosch IoT Things is build on top). There are four keys that are making the basic message frame topic, headers, path and value. Topic identifies what kind of message we are receiving, while path identifies which part of the Digital Twin is the origin of the message. Headers is a key-value map with meta information for message procssing (just like in HTTP requests). Value contains the payload that we are interessted in. You can find more information regarding the protocol in the Eclipse Ditto <a href=\"https://www.eclipse.org/ditto/protocol-overview.html\">documentation</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n\t<span class=\"token property\">\"topic\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"namespace/thing_id/type_of_message\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token property\">\"headers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    ...\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token property\">\"path\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"path_relating_to_feature\"</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token property\">\"value\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    ...\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Congratulations, you are now able to send and receive message to and from the IoT Suite. A possible improvement would of course be to check the IoT Hub’s certificate for authenticity. But I will leave this to you. </p>\n<p>The following is a slightly cleaned up full example of what we just did. We will use this in the next post to continue the integration work. You can find the complete project on <a href=\"https://www.github.com/cgrotz/esp32-iot-hub-connection\">Github</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;Arduino.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;WiFiClientSecure.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;ArduinoJson.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;MQTT.h></span></span>\n\n<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> ssid<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;Wifi SSID>\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> pass<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;Wifi Password>\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Connetion parameters from the provisioning json file</span>\n<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> hubNamespace<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;the namespace we created>\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> deviceId<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;deviceId>\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> tenantId<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;iot hub tenant>\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token keyword\">char</span> mqttPassword<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;MQTT Password>\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Since Bosch IoT Hub needs TLS, we need to use the WifiClient Secure instead of the normal Wifi Client</span>\nWiFiClientSecure net<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// We need to increase message size since the IoT Suite messages can be rather big</span>\nMQTTClient <span class=\"token function\">client</span><span class=\"token punctuation\">(</span><span class=\"token number\">2048</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">long</span> lastMillis <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">messageReceived</span><span class=\"token punctuation\">(</span>String <span class=\"token operator\">&amp;</span>mqttTopic<span class=\"token punctuation\">,</span> String <span class=\"token operator\">&amp;</span>payload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  StaticJsonDocument<span class=\"token operator\">&lt;</span><span class=\"token number\">2000</span><span class=\"token operator\">></span> doc<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">deserializeJson</span><span class=\"token punctuation\">(</span>doc<span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  String topic <span class=\"token operator\">=</span> doc<span class=\"token punctuation\">[</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  String path <span class=\"token operator\">=</span> doc<span class=\"token punctuation\">[</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"incoming topic: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span>topic<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" path: \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"incoming: \"</span> <span class=\"token operator\">+</span> mqttTopic <span class=\"token operator\">+</span> <span class=\"token string\">\" - \"</span> <span class=\"token operator\">+</span> payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// Note: Do not use the client in the callback to publish, subscribe or</span>\n  <span class=\"token comment\">// unsubscribe as it may cause deadlocks when other things arrive while</span>\n  <span class=\"token comment\">// sending and receiving acknowledgments. Instead, change a global variable,</span>\n  <span class=\"token comment\">// or push to a queue and handle it in the loop after calling `client.loop()`.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nchecking wifi...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>WiFi<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> WL_CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" connected to wifi!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nconnecting to mqtt...\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mqtt.bosch-iot-hub.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8883</span><span class=\"token punctuation\">,</span> net<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span>messageReceived<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">int</span> wait <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">char</span> mqttDeviceId<span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">char</span> mqttUsername<span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>mqttDeviceId<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%s:%s\"</span><span class=\"token punctuation\">,</span> hubNamespace<span class=\"token punctuation\">,</span> deviceId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>mqttUsername<span class=\"token punctuation\">,</span> <span class=\"token string\">\"%s_%s@%s\"</span><span class=\"token punctuation\">,</span> hubNamespace<span class=\"token punctuation\">,</span> deviceId<span class=\"token punctuation\">,</span> tenantId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>mqttDeviceId<span class=\"token punctuation\">,</span> mqttUsername<span class=\"token punctuation\">,</span>mqttPassword<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> wait <span class=\"token operator\">&lt;</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    wait<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">connected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" not connected to mqtt!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" connected to mqtt!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// Subscribe to commands from IoT Suite</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"command///req/#\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">setup</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Serial<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span><span class=\"token number\">115200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  WiFi<span class=\"token punctuation\">.</span><span class=\"token function\">begin</span><span class=\"token punctuation\">(</span>ssid<span class=\"token punctuation\">,</span> pass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> <span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  client<span class=\"token punctuation\">.</span><span class=\"token function\">loop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// we add a few millisecond delay for wifi stability</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">connected</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// publish a message roughly every second.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> lastMillis <span class=\"token operator\">></span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    lastMillis <span class=\"token operator\">=</span> <span class=\"token function\">millis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">char</span> payload<span class=\"token punctuation\">[</span><span class=\"token number\">1000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">sprintf</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">,</span> <span class=\"token string\">\"{\\r\\n\\t\\\"topic\\\": \\\"%s/%s/things/twin/commands/modify\\\",\\r\\n\\t\\\"path\\\": \\\"/features/version\\\",\\r\\n\\t\\\"value\\\": {\\r\\n\\t \\t\\\"properties\\\": {\\r\\n \\t\\t \\t\\\"version\\\": \\\"1.0.8\\\"\\r\\n\\t\\t}\\r\\n\\t}\\r\\n}\"</span><span class=\"token punctuation\">,</span>hubNamespace<span class=\"token punctuation\">,</span> deviceId <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">publish</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"event\"</span><span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed publishing \"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      Serial<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">.</span><span class=\"token function\">lastError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"Connecting the ESP32 to the Bosch IoT Suite","date":"August 31, 2020","description":"In this part we beginn with connecting our device with the Bosch IoT Suite."}}},"pageContext":{"slug":"/2020-08-31-esp32_ci_cd_part5/","previous":{"fields":{"slug":"/2020-08-26-esp32_ci_cd_part4/"},"frontmatter":{"title":"Uploading the firmware to Bosch IoT Rollouts"}},"next":null}},"staticQueryHashes":["1246554614","2841359383"]}